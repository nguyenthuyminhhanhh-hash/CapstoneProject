name: ğŸ•µï¸ CI - Build & Lint Services

# KÃ­ch hoáº¡t workflow khi push hoáº·c PR vÃ o 'main' hoáº·c 'develop'
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # TÃªn job chÃ­nh
  build-and-lint:
    runs-on: ubuntu-latest

    # --- Ma tráº­n (Matrix) ---
    # ÄÃ¢y lÃ  pháº§n "chi tiáº¿t"
    strategy:
      fail-fast: false # ğŸ’¡ Náº¿u 1 service lá»—i, cÃ¡c service khÃ¡c váº«n tiáº¿p tá»¥c cháº¡y
      matrix:
        # Liá»‡t kÃª táº¥t cáº£ cÃ¡c service cá»§a báº¡n á»Ÿ Ä‘Ã¢y
        service:
          - user-service
          - auth-service
          - product-service
          - inventory-service
          - cart-service
          - order-service
          - payment-service
          # (TÃ´i Ä‘oÃ¡n báº¡n Ä‘Ã£ xÃ³a/thay tháº¿ frontend-service, náº¿u cÃ²n hÃ£y thÃªm vÃ o Ä‘Ã¢y)
          # - frontend-service 

    steps:
      # 1. Láº¥y code tá»« repository
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      # 2. CÃ i Ä‘áº·t Python (Ä‘á»ƒ cháº¡y Lint)
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Pháº£i khá»›p vá»›i Dockerfile cá»§a báº¡n

      # 3. CÃ i Ä‘áº·t Flake8 (CÃ´ng cá»¥ kiá»ƒm tra lá»—i code Python)
      - name: ğŸ“¦ Install Flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      # 4. Cháº¡y Lint (Kiá»ƒm tra lá»—i cÃº phÃ¡p)
      # NÃ³ sáº½ cháº¡y 1 láº§n cho Má»–I service trong ma tráº­n (vÃ­ dá»¥: ./services/user-service/app)
      - name: ğŸ’… Lint ${{ matrix.service }}
        run: |
          echo "Linting ./services/${{ matrix.service }}/app"
          # Lá»‡nh 'flake8' sáº½ bÃ¡o lá»—i náº¿u code báº¡n (vd: trong 'app/') vi pháº¡m chuáº©n
          flake8 ./services/${{ matrix.service }}/app --max-line-length=120

      # 5. CÃ i Ä‘áº·t Docker Buildx (cáº§n thiáº¿t cho build)
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. Build Docker image
      # ÄÃ¢y lÃ  bÃ i test quan trá»ng nháº¥t: Äáº£m báº£o service cÃ³ thá»ƒ Ä‘Æ°á»£c build
      # NÃ³ sáº½ cháº¡y 1 láº§n cho Má»–I service trong ma tráº­n
      - name: ğŸ§± Build ${{ matrix.service }}
        run: |
          docker build \
            --tag ${{ matrix.service }}:ci-test \
            ./services/${{ matrix.service }}